version: 2.1

orbs:
  python: circleci/python@2.1.1
  node: circleci/node@5.0.2

jobs:
  test:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      
      # Set up Python
      - python/install-packages:
          pkg-manager: pip
          app-dir: .
          pip-dependency-file: requirements.txt
      
      # Run BDD tests
      - run:
          name: Run BDD tests
          command: |
            python -m behave --no-capture
      
      # Set up Node.js and Newman
      - node/install:
          install-yarn: false
          node-version: '18'
      
      - run:
          name: Install Newman
          command: |
            sudo npm install -g newman
            newman --version
      
      # Run Postman collection tests
      - run:
          name: Run Postman Collection Tests
          command: |
            mkdir -p test-results/newman
            
            if [ -f "postman/room_api_tests.postman_collection.json" ]; then
              echo "Running Postman collection..."
              newman run "postman/room_api_tests.postman_collection.json" \
                --reporters cli,junit \
                --reporter-junit-export "test-results/newman/results.xml" \
                || (echo "Postman tests failed" && exit 1)
            else
              echo "Postman collection not found!"
              exit 1
            fi
      
      # Save test results
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results

workflows:
  version: 2
  test-and-deploy:
    jobs:
      - test
